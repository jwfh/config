WRKSRC!=	pwd
BINDEST=	${PREFIX}/bin
CONFDEST=	${.CURDIR:C/[^\/]*\/[^\/]*$/.ssh/}
CONFFILE=	${CONFDEST:=/config}

.if ! defined(ALLCONFFILES)
ALLCONFFILES!=	find "${CONFDEST}" -type f -name config.\*
.endif
PREAMBLE!=	cat ${.CURDIR:=/config.preamble}

SCRIPT=		ssh-addkeys

.include "../config.env.mk"
.include "../config.commands.mk"

.MAIN: makeconfig install

makeconfig: .PHONY ${CONFFILE}.base 
.if exists(${CONFFILE})
	@${ECHO_MSG} "/!\\ WARNING: Existing configuration found /!\\"
	@${ECHO_MSG} ""
	@${ECHO_MSG} "===> Backing up existing SSH configuration at ${CONFFILE}"
	@${MV} "${CONFFILE}" "${CONFFILE:=.bak}"
	@${ECHO_MSG} "  ===> Previous confiruration saved at ${CONFFILE:=.bak}"
.else 
	@${ECHO_MSG} "===> No existing SSH configuration exists at ${CONFFILE}"
.endif
	@${ECHO_MSG} ""
	@${ECHO_MSG} "===> Creating new SSH configuration file at ${CONFFILE}"
	@${ECHO_MSG} "# DO NOT EDIT THIS FILE -- dotfiles" > ${CONFFILE}
	@${ECHO_MSG} "" >> ${CONFFILE}
	@${ECHO_MSG} "${PREAMBLE}" | ${FMT_80} | ${SED} -e 's/^/# /' >> ${CONFFILE}
	@${ECHO_MSG} "" >> ${CONFFILE}
	@${ECHO_MSG} "  ===> Prefacing configuation file with global options"
	@${CAT} ${CONFFILE}.base >> ${CONFFILE}

.if exists(${CONFFILE}.${HOSTNAME})
	@${ECHO_MSG} "  ===> Customizing with host-specific options for ${HOSTNAME:tu}"
	@${CAT} "${CONFFILE}.${HOSTNAME}" >> "${CONFFILE}"
.else
	@${ECHO_MSG} "  ===> No host-specific options found for ${HOSTNAME:tu}"
.endif

.for FILE in ${ALLCONFFILES:N*.bak}
	@${ECHO_MSG} "  ===> Appending configuration from ${FILE}"
	@${CAT} ${FILE} >> ${CONFFILE}
.endfor

	@${ECHO_MSG} "===> SSH configuration file written to ${CONFFILE}"

install: ${SCRIPT:=-install}

uninstall: ${SCRIPT:=-uninstall}

${SCRIPT:=-install}:
	@${PRINTF} "===> Linking script \`${@:-install=}\`\n"
	@${INSTALL_SCRIPT} ${WRKSRC}/${@:-install=} ${BINDEST}

${SCRIPT:=-uninstall}:
	@${PRINTF} "===> Unlinking script \`${@:-uninstall=}\`\n"
	@${RM} ${BINDEST}/${@:-uninstall=} 

.PHONY:
