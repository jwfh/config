<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>Slightly stricter</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK
REL="HOME"
TITLE="Firewalling with OpenBSD's PF packet filter
  "
HREF="index.html"><LINK
REL="PREVIOUS"
TITLE="First rule set - single machine"
HREF="minimal-ruleset.html"><LINK
REL="NEXT"
TITLE="Statistics from pfctl"
HREF="pfctlstats.html"><LINK
REL="STYLESHEET"
TYPE="text/css"
HREF="docbook.css"><meta
http-equiv="Content-Type"
content="text/html; charset=ISO-8859-1"></HEAD
><BODY
CLASS="CHAPTER"
BGCOLOR="#FFFFFF"
TEXT="#000000"
LINK="#0000FF"
VLINK="#840084"
ALINK="#0000FF"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="3"
ALIGN="center"
>Firewalling with OpenBSD's PF packet filter</TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="bottom"
><A
HREF="minimal-ruleset.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="80%"
ALIGN="center"
VALIGN="bottom"
></TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="bottom"
><A
HREF="pfctlstats.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="CHAPTER"
><H1
><A
NAME="STRICTER"
></A
>Slightly stricter</H1
><P
>For a slightly more structured and complete setup, we start by denying
everything and then allowing only those things we know that we
need<A
NAME="AEN577"
HREF="#FTN.AEN577"
><SPAN
CLASS="footnote"
>[1]</SPAN
></A
>.  This gives us
the opportunity to introduce two of the features which make PF such a
wonderful tool - lists and macros.</P
><P
>We'll make some changes to <TT
CLASS="FILENAME"
>/etc/pf.conf</TT
>, starting with</P
><PRE
CLASS="PROGRAMLISTING"
>block all</PRE
><P
>Then we back up a little. Macros need to be defined before use:</P
><PRE
CLASS="PROGRAMLISTING"
>tcp_services = "{ ssh, smtp, domain, www, pop3, auth, pop3s }"
udp_services = "{ domain }"</PRE
><P
>Now we've demonstrated several things at once - what macros look like,
we've shown that macros may be lists, and that PF understands rules using
port names equally well as it does port numbers.  The names are the ones
listed in <TT
CLASS="FILENAME"
>/etc/services</TT
>.  This gives us something
to put in our rules, which we edit slightly to look like this:</P
><PRE
CLASS="PROGRAMLISTING"
>block all
pass out proto tcp to port $tcp_services
pass proto udp to port $udp_services</PRE
><P
>Please remember to add <KBD
CLASS="USERINPUT"
>keep state</KBD
> to these rules if
your system has a PF version older than OpenBSD 4.1.</P
><P
>At this point some of us will point out that UDP is stateless, but PF
actually manages to maintain state information despite this.  When you
ask a name server about a domain name, it is reasonable to assume that
you probably want to receive the answer.  Retaining state information
about your UDP traffic achieves this.</P
><P
>Since we've made changes to our <TT
CLASS="FILENAME"
>pf.conf</TT
> file, we
load the new rules:</P
><PRE
CLASS="SCREEN"
><SAMP
CLASS="COMPUTEROUTPUT"
>$</SAMP
> <KBD
CLASS="USERINPUT"
><SPAN
CLASS="APPLICATION"
>doas</SPAN
> <SPAN
CLASS="APPLICATION"
>pfctl</SPAN
> -f <TT
CLASS="FILENAME"
>/etc/pf.conf</TT
></KBD
></PRE
><P
>and the new rules apply.  If there are no syntax errors, 
<SPAN
CLASS="APPLICATION"
>pfctl</SPAN
> will not output any messages during the rule load.
The -v flag will produce more verbose <SPAN
CLASS="APPLICATION"
>pfctl</SPAN
> output.</P
><P
>If you have made extensive changes to your rule set, you may want to
check the rules before attempting to load them. The command to do this
is, <KBD
CLASS="USERINPUT"
><SPAN
CLASS="APPLICATION"
>pfctl</SPAN
> -nf
<TT
CLASS="FILENAME"
>/etc/pf.conf</TT
></KBD
>.  The
<KBD
CLASS="USERINPUT"
>-n</KBD
> option causes the rules to be interpreted
only without loading the rules.  This gives you an opportunity to
correct any errors.  Under any circumstances the last valid rule set
loaded will be in force until you either disable PF or load a new rule
set.</P
><P
>That is worth noting: When loading a new rule set, the last valid rule
set stays loaded until the new one is fully parsed and loaded, and PF
switches directly from one to the other. There is no intermediate
stage with no rules loaded or a mixture of the two rule sets.</P
></DIV
><H3
CLASS="FOOTNOTES"
>Notes</H3
><TABLE
BORDER="0"
CLASS="FOOTNOTES"
WIDTH="100%"
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
WIDTH="5%"
><A
NAME="FTN.AEN577"
HREF="stricter.html#AEN577"
><SPAN
CLASS="footnote"
>[1]</SPAN
></A
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
WIDTH="95%"
><P
>You may ask why do I write the rule set to default
deny?  The short answer is, it gives you better control at the expense
of some thinking. The point of packet filtering is to take control,
not to run catch-up with what the bad guys do. Marcus Ranum has
written a very entertaining and informative article about this, <A
HREF="http://www.ranum.com/security/computer_security/editorials/dumb/index.html"
TARGET="_top"
>The
Six Dumbest Ideas in Computer Security</A
>, which comes highly
recommended.  It is a good read.</P
></TD
></TR
></TABLE
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="minimal-ruleset.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>Home</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="pfctlstats.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>First rule set - single machine</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
>&nbsp;</TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>Statistics from <SPAN
CLASS="APPLICATION"
>pfctl</SPAN
></TD
></TR
></TABLE
></DIV
></BODY
></HTML
>