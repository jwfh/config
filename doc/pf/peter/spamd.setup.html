<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>Setting up spamd</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK
REL="HOME"
TITLE="Firewalling with OpenBSD's PF packet filter
  "
HREF="index.html"><LINK
REL="UP"
TITLE="Giving spammers a hard time"
HREF="spamd.html"><LINK
REL="PREVIOUS"
TITLE="List of black and grey, and the sticky tarpit"
HREF="spamd.tarandgrey.html"><LINK
REL="NEXT"
TITLE="Some early highlights of our spamd experience"
HREF="spamd.experience.html"><LINK
REL="STYLESHEET"
TYPE="text/css"
HREF="docbook.css"><meta
http-equiv="Content-Type"
content="text/html; charset=ISO-8859-1"></HEAD
><BODY
CLASS="SECTION"
BGCOLOR="#FFFFFF"
TEXT="#000000"
LINK="#0000FF"
VLINK="#840084"
ALINK="#0000FF"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="3"
ALIGN="center"
>Firewalling with OpenBSD's PF packet filter</TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="bottom"
><A
HREF="spamd.tarandgrey.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="80%"
ALIGN="center"
VALIGN="bottom"
>Giving spammers a hard time</TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="bottom"
><A
HREF="spamd.experience.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="SECTION"
><H1
CLASS="SECTION"
><A
NAME="SPAMD.SETUP"
>Setting up <SPAN
CLASS="APPLICATION"
>spamd</SPAN
></A
></H1
><P
>With the necessary rules in place in your
<TT
CLASS="FILENAME"
>pf.conf</TT
>, configuring spamd is fairly
straightforward<A
NAME="AEN1651"
HREF="#FTN.AEN1651"
><SPAN
CLASS="footnote"
>[1]</SPAN
></A
>.  You simply edit your <TT
CLASS="FILENAME"
>spamd.conf</TT
> (traditionally stored in the <TT
CLASS="FILENAME"
>/etc</TT
> directory, but on OpenBSD 4.1 and newer the file has migrated to <TT
CLASS="FILENAME"
>/etc/mail</TT
>),
according to your own needs.  The file itself offers quite a bit of
explanation, and the man page offers additional information, but we
will recap the essentials here.</P
><DIV
CLASS="NOTE"
><P
></P
><TABLE
CLASS="NOTE"
WIDTH="100%"
BORDER="0"
><TR
><TD
WIDTH="25"
ALIGN="CENTER"
VALIGN="TOP"
><IMG
SRC="./note.jpg"
HSPACE="5"
ALT="Note"></TD
><TH
ALIGN="LEFT"
VALIGN="MIDDLE"
><B
>This is about the OpenBSD spam deferral daemon <A
HREF="http://man.openbsd.org/spamd"
TARGET="_top"
>spamd(8)</A
>, not the Spamassassin component</B
></TH
></TR
><TR
><TD
>&nbsp;</TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>Please note that this text describes the OpenBSD spam deferral daemon <A
HREF="http://man.openbsd.org/spamd"
TARGET="_top"
>spamd(8)</A
>, not the similarly named program that is part of the Apache project's SpamAssassin content filtering system. The spam deferral daemon and the content filtering system complement each other well and can even coexist on the same system (the binaries install to different paths unless you've done something you shouldn't have). If you're primarily interested in the content filterling system, please head over to <A
HREF="http://spamassassin.apache.org/"
TARGET="_top"
>spamassassin.apache.org</A
> for information on that system.
  </P
></TD
></TR
></TABLE
></DIV
><P
>One of the first lines without a <KBD
CLASS="USERINPUT"
>#</KBD
> comment sign
at the start contains the block which defines the
<KBD
CLASS="USERINPUT"
>all</KBD
> list, which specifies the lists you actually
use:</P
><PRE
CLASS="PROGRAMLISTING"
>all:\
:bsdly:whitelist:</PRE
><P
>Here you add all black lists you want to use, separated by colons (:).
If you want to use whitelists to subtract addresses from your blacklist, you 
add the name of the whitelist immediately after the name of each blacklist, ie 
<KBD
CLASS="USERINPUT"
>:blacklist:whitelist:</KBD
>.  </P
><P
>Next up is a blacklist definition:</P
><PRE
CLASS="PROGRAMLISTING"
>bsdly:\
        :black:\
        :msg="SPAM.  Your address %A has sent spam within the last 24 hours.  See http://www.bsdly.net/~peter/traplist.shtml for details.":\
        :method=http:\
        :file=www.bsdly.net/~peter/bsdly.net.traplist</PRE
><P
>Following the name, the first data field specifies the list type, in
this case <KBD
CLASS="USERINPUT"
>black</KBD
>.  The
<I
CLASS="FIRSTTERM"
>msg</I
> field contains the message to display to
blacklisted senders during the SMTP dialogue.  The
<I
CLASS="FIRSTTERM"
>method</I
> field specifies how spamd-setup fetches
the list data, here <KBD
CLASS="USERINPUT"
>http</KBD
>.  The other options
are fetching via <KBD
CLASS="USERINPUT"
>ftp</KBD
>, from a
<KBD
CLASS="USERINPUT"
>file</KBD
> in a mounted file system or via
<KBD
CLASS="USERINPUT"
>exec</KBD
> of an external program.  Finally the
<I
CLASS="FIRSTTERM"
>file</I
> field specifies the name of the file spamd
expects to receive.</P
><P
>The definition of a whitelist follows much the same pattern:</P
><PRE
CLASS="PROGRAMLISTING"
>whitelist:\
        :white:\
        :method=file:\
        :file=/etc/mail/whitelist.txt</PRE
><P
>but omits the message parameter since a message is not needed.</P
><DIV
CLASS="TIP"
><P
></P
><TABLE
CLASS="TIP"
WIDTH="100%"
BORDER="0"
><TR
><TD
WIDTH="25"
ALIGN="CENTER"
VALIGN="TOP"
><IMG
SRC="./tip.jpg"
HSPACE="5"
ALT="Tip"></TD
><TH
ALIGN="LEFT"
VALIGN="MIDDLE"
><B
>Choose your data sources with care</B
></TH
></TR
><TR
><TD
>&nbsp;</TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>Enabling the suggested blacklists in earlier versions of the default as distributed
<TT
CLASS="FILENAME"
>spamd.conf</TT
> could lead to blacklisting of quite
large blocks of the Internet, including several countries such as
Korea.  I work in a company which actually does the odd bit of
business with Koreans, and consequently I needed to edit out that
particular entry from our configuration.  You are the judge of which
data sources to use, and using other lists than the default ones is
possible.</P
></TD
></TR
></TABLE
></DIV
><P
>Put the lines for spamd and the startup parameters you want in your
<TT
CLASS="FILENAME"
>/etc/rc.conf</TT
> or <TT
CLASS="FILENAME"
>/etc/rc.conf.local</TT
>, for example</P
><PRE
CLASS="PROGRAMLISTING"
>spamd_flags="-v -G 2:4:864" # for normal use: "" and see spamd-setup(8)
spamd_grey=YES              # use spamd greylisting if YES</PRE
><P
>Once again, on OpenBSD 4.1 onwards, the
<KBD
CLASS="USERINPUT"
>spamd_grey</KBD
> variable is superfluous.  If you
want <SPAN
CLASS="APPLICATION"
>spamd</SPAN
> to run in pure blacklist mode
without greylisting, you use the <KBD
CLASS="USERINPUT"
>spamd_black</KBD
>
variable to turn off greylisting and enable blacklisting mode.</P
><P
>Note for that you can fine tune several of the greylisting related
parameters via <SPAN
CLASS="APPLICATION"
>spamd</SPAN
> command line
parameters.  Check the <SPAN
CLASS="APPLICATION"
>spamd</SPAN
> man page to
see what the parameters mean.</P
><P
>When you are done with editing the setup, you start
<SPAN
CLASS="APPLICATION"
>spamd</SPAN
> with the options you want, and
complete the configuration using
<SPAN
CLASS="APPLICATION"
>spamd-setup</SPAN
>.  Finally, you create a
<SPAN
CLASS="APPLICATION"
>cron</SPAN
> job which calls
<SPAN
CLASS="APPLICATION"
>spamd-setup</SPAN
> to update the tables at
reasonable intervals.</P
><P
>Once the tables are filled, you can view table contents using
<SPAN
CLASS="APPLICATION"
>pfctl</SPAN
> or other applications.  If you want
to change or delete entries, you are advised to use the
<SPAN
CLASS="APPLICATION"
>spamdb</SPAN
> utility instead of
<SPAN
CLASS="APPLICATION"
>pfctl</SPAN
> table commands.  More about that
later.</P
><P
>Note that the example above uses rdr rules which are also pass rules.
If your rdr rules do not include a 'pass' part, you need to set up
pass rules to let traffic through to your redirection.  You also need
to set up rules to let legitimate email through.  If you are already
running an email service on your network, you can probably go on using
your old SMTP pass rules.</P
></DIV
><H3
CLASS="FOOTNOTES"
>Notes</H3
><TABLE
BORDER="0"
CLASS="FOOTNOTES"
WIDTH="100%"
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
WIDTH="5%"
><A
NAME="FTN.AEN1651"
HREF="spamd.setup.html#AEN1651"
><SPAN
CLASS="footnote"
>[1]</SPAN
></A
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
WIDTH="95%"
><P
>Note that on FreeBSD, <SPAN
CLASS="APPLICATION"
>spamd</SPAN
> is a port,
<TT
CLASS="FILENAME"
>mail/spamd/</TT
>. If you are running PF on
FreeBSD 5.n or newer, you need to install the port, follow the
directions given by the port's messages and return here.</P
><P
>In particular, to use <SPAN
CLASS="APPLICATION"
>spamd</SPAN
>'s
greylisting features, you need to have a file descriptor file system
 (see <A
HREF="http://www.freebsd.org/cgi/man.cgi?query=fdescfs&#38;sektion=5"
TARGET="_top"
>fdescfs(5)</A
>)
  mounted
at <TT
CLASS="FILENAME"
>/dev/fd/</TT
>.  You do this by adding the following
line to your <TT
CLASS="FILENAME"
>/etc/fstab</TT
>:</P
><P
><PRE
CLASS="PROGRAMLISTING"
> fdescfs /dev/fd fdescfs rw 0 0</PRE
></P
><P
>and making sure the <TT
CLASS="FILENAME"
>fdescfs</TT
> code is in your
kernel, either compiled in or by loading the module via the appropriate <SPAN
CLASS="APPLICATION"
>kldload</SPAN
> command.</P
></TD
></TR
></TABLE
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="spamd.tarandgrey.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>Home</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="spamd.experience.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>List of black and grey, and the sticky tarpit</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="spamd.html"
ACCESSKEY="U"
>Up</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>Some early highlights of our <SPAN
CLASS="APPLICATION"
>spamd</SPAN
> experience</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>