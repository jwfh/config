<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>Directing traffic with ALTQ</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK
REL="HOME"
TITLE="Firewalling with OpenBSD's PF packet filter
  "
HREF="index.html"><LINK
REL="PREVIOUS"
TITLE="Invisible gateway - bridge"
HREF="bridge.html"><LINK
REL="NEXT"
TITLE="ALTQ - allocation by percentage"
HREF="altqbypct.html"><LINK
REL="STYLESHEET"
TYPE="text/css"
HREF="docbook.css"><meta
http-equiv="Content-Type"
content="text/html; charset=ISO-8859-1"></HEAD
><BODY
CLASS="CHAPTER"
BGCOLOR="#FFFFFF"
TEXT="#000000"
LINK="#0000FF"
VLINK="#840084"
ALINK="#0000FF"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="3"
ALIGN="center"
>Firewalling with OpenBSD's PF packet filter</TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="bottom"
><A
HREF="bridge.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="80%"
ALIGN="center"
VALIGN="bottom"
></TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="bottom"
><A
HREF="altqbypct.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="CHAPTER"
><H1
><A
NAME="ALTQINTRO"
></A
>Directing traffic with ALTQ</H1
><DIV
CLASS="TOC"
><DL
><DT
><B
>Table of Contents</B
></DT
><DT
><A
HREF="altqintro.html#ALTQACKPRI"
>ALTQ - prioritizing by traffic type</A
></DT
><DT
><A
HREF="altqbypct.html"
>ALTQ - allocation by percentage</A
></DT
><DT
><A
HREF="altqsmtp.html"
>ALTQ - handling unwanted traffic</A
></DT
></DL
></DIV
><P
>ALTQ - short for ALTernate Queueing - is a very flexible mechanism for
directing network traffic which lived a life of its own before getting
integrated into PF.  Altq was another one of those things which were
integrated into PF because of the additional convenience it offered
when integrated.</P
><DIV
CLASS="NOTE"
><P
></P
><TABLE
CLASS="NOTE"
WIDTH="100%"
BORDER="0"
><TR
><TD
WIDTH="25"
ALIGN="CENTER"
VALIGN="TOP"
><IMG
SRC="./note.jpg"
HSPACE="5"
ALT="Note"></TD
><TH
ALIGN="LEFT"
VALIGN="MIDDLE"
><B
>Note: OpenBSD traffic shaping uses a different, simpler syntax</B
></TH
></TR
><TR
><TD
>&nbsp;</TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>The new traffic shaping framework <A
HREF="http://bsdly.blogspot.com/2011/07/what-to-expect-in-openbsd-50-onwards.html"
TARGET="_top"
>hinted at</A
> by commits as far back as the development phase for OpenBSD 5.0 was finally introduced in OpenBSD 5.5 and from OpenBSD 5.6 it's the only traffic shaping option available. If you want a gentler introduction to the new traffic shaping system than what's offered by the official documentation, please see the relevant parts of <A
HREF="http://www.nostarch.com/pf3"
TARGET="_top"
>The Book of PF</A
> (3rd edition) or see the <A
HREF="http://home.nuug.no/~peter/pf/newest/"
TARGET="_top"
>slides</A
> 
matching my latest tutorial session.</P
></TD
></TR
></TABLE
></DIV
><P
>ALTQ uses the term <I
CLASS="FIRSTTERM"
>queue</I
> about the main traffic
control mechanisms. Queues are defined with a defined amount of bandwidth
or a specific part of available bandwidth, where a queue can be assigned 
subqueues of various types.</P
><P
>To complete the picture, you write filtering rules which assign
packets to specified queues or a selection of subqueues where packets
pass according to specified criteria.</P
><P
>Queues are created with one of several queue
<I
CLASS="FIRSTTERM"
>disciplines</I
>.  The default queue discipline
without ALTQ is FIFO (first, in first out).  </P
><P
>A slightly more interesting discipline is the class based discipline
(CBQ), which in practical terms means you define the queue's bandwidth
as a set amount of data per second, as a percentage or in units of
kilobits, megabits and so on, with an additional priority as an
option, or priority based (priq), where you assign priority only.</P
><P
>Priorities can be set at 0 to 7 for cbq queues, 0 to 15 for priq
queues, with a higher value assigning a higher priority and
preferential treatment. In addition, the hierarchical queue algorithm
"Hierarchical Fair Service Curve" or HFSC is available.</P
><P
>Briefly, a simplified syntax is</P
><PRE
CLASS="PROGRAMLISTING"
>altq on interface type [options ... ] main_queue { sub_q1, sub_q2 ..}
  queue sub_q1 [ options ... ]
  queue sub_q2 [ options ... ]
[...]
pass [ ... ] queue sub_q1
pass [ ... ] queue sub_q2</PRE
><P
>If you will be using these features in you own rule sets, you 
should under any circumstances read the <TT
CLASS="FILENAME"
>pf.conf</TT
> man page
and the PF user guide. These documents offer a very detailed and reasonably
well laid out explanation of the syntax and options.<A
NAME="AEN1304"
HREF="#FTN.AEN1304"
><SPAN
CLASS="footnote"
>[1]</SPAN
></A
>
<A
NAME="AEN1307"
HREF="#FTN.AEN1307"
><SPAN
CLASS="footnote"
>[2]</SPAN
></A
></P
><DIV
CLASS="SECTION"
><H1
CLASS="SECTION"
><A
NAME="ALTQACKPRI"
>ALTQ - prioritizing by traffic type</A
></H1
><P
>Our first real example is lifted from Daniel Hartmeier's web.
Like quite a few of us, Daniel is on an asymmetric connection, and naturally
he wanted to get better bandwidth utilization. </P
><P
>One symptom in particular seemed to indicate that there was room for
improvement. Incoming traffic (downloads) apparently slowed down
outgoing traffic. </P
><P
>Analyzing the data indicated that the ACK packets for each data packet
transferred caused a disproportionately large slowdown, possibly due to
the FIFO (First In, First Out) queue discipline in effect on the outgoing
traffic.</P
><P
>A testable hypothesis formed - if the tiny, practically dataless ACK
packets were able to slip inbetween the larger data packets, this
would lead to a more efficient use of available bandwidth. The means
were two queues with different priorities. The relevant parts of the
rule set follows:</P
><PRE
CLASS="PROGRAMLISTING"
>ext_if="kue0"

altq on $ext_if priq bandwidth 100Kb queue { q_pri, q_def }
queue q_pri priority 7
queue q_def priority 1 priq(default)

pass out on $ext_if proto tcp from $ext_if to any flags S/SA \
        keep state queue (q_def, q_pri)

pass in  on $ext_if proto tcp from any to $ext_if flags S/SA \
        keep state queue (q_def, q_pri)</PRE
><P
>The result was indeed better performance. </P
><DIV
CLASS="SECTION"
><H2
CLASS="SECTION"
><A
NAME="ALTQACKPRI.TOS"
>So why does this work?</A
></H2
><P
>So why does this work?<A
NAME="AEN1321"
HREF="#FTN.AEN1321"
><SPAN
CLASS="footnote"
>[3]</SPAN
></A
> The reason lies in how the ALTQ code treats
subqueues with different priorities.  Once a connection is assigned to
the main queue, ALTQ inspects each packet's type of service (ToS)
field.  ACK packets have the ToS Delay bit set to 'low', which
indicates that the sender wanted the speediest delivery possible.</P
><P
>When ALTQ sees a low delay packet and queues of differing priorities
are available, it will assign the packet to the higher priority queue.
This means that the ACK packets skip ahead of the lower priority queue
and are delivered more quickly, which in turn means that data packets
are serviced more quickly, too.</P
><P
>Daniel's article is available from his web site at <A
HREF="http://www.benzedrine.ch/ackpri.html"
TARGET="_top"
>http://www.benzedrine.ch/ackpri.html</A
>. Also see an <A
HREF="http://home.nuug.no/~peter/pf/newest/prio.html"
TARGET="_top"
>equivalent example</A
> using the new syntax.</P
></DIV
><DIV
CLASS="SECTION"
><H2
CLASS="SECTION"
><A
NAME="MATCHQUEUEASSIGN"
>Using a match Rule for Queue Assignment</A
></H2
><P
>Starting with OpenBSD 4.6, it is possible to assign traffic to queues using <KBD
CLASS="USERINPUT"
>match</KBD
> rules as well as <KBD
CLASS="USERINPUT"
>pass</KBD
> rules.  This makes it extremely easy to add an ALTQ regime to an existing rule set.  In order to apply the priority scheme we just presented to an existing rule set on OpenBSD 4.6 or newer, you would add teh <KBD
CLASS="USERINPUT"
>altq</KBD
> definition block at the top of the rule set, followed by the following rule:</P
><PRE
CLASS="SCREEN"
>match out on $ext_if from $int_if:network queue (q_def, q_pri)</PRE
><P
>If your gateway does NAT, it could also be useful to rewrite the <KBD
CLASS="USERINPUT"
>match</KBD
> rule that applies the <KBD
CLASS="USERINPUT"
>nat-to</KBD
> to do the queue assignment as well (simply tack on the queue assignment at the end).</P
></DIV
></DIV
></DIV
><H3
CLASS="FOOTNOTES"
>Notes</H3
><TABLE
BORDER="0"
CLASS="FOOTNOTES"
WIDTH="100%"
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
WIDTH="5%"
><A
NAME="FTN.AEN1304"
HREF="altqintro.html#AEN1304"
><SPAN
CLASS="footnote"
>[1]</SPAN
></A
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
WIDTH="95%"
><P
>On FreeBSD, ALTQ requires the ALTQ and queue discipline options for the disciplines
you want to use to be compiled
into the running kernel. Refer to  
<A
HREF="http://www.freebsd.org/doc/en_US.ISO8859-1/books/handbook/firewalls-pf.html"
TARGET="_top"
>the PF chapter</A
> 
of the FreeBSD Handbook for further information.</P
></TD
></TR
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
WIDTH="5%"
><A
NAME="FTN.AEN1307"
HREF="altqintro.html#AEN1307"
><SPAN
CLASS="footnote"
>[2]</SPAN
></A
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
WIDTH="95%"
><P
>At the time of writing, ALTQ was integrated in 
the NetBSD's PF in time for the 4.0 release.  For up to date
information on this see <A
HREF="http://www.netbsd.org/Documentation/network/pf.html"
TARGET="_top"
>The NetBSD PF documentation</A
>.</P
></TD
></TR
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
WIDTH="5%"
><A
NAME="FTN.AEN1321"
HREF="altqintro.html#AEN1321"
><SPAN
CLASS="footnote"
>[3]</SPAN
></A
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
WIDTH="95%"
><P
>Earlier versions of this
tutorial left the explanation pretty much as an exercise to the
reader.</P
></TD
></TR
></TABLE
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="bridge.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>Home</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="altqbypct.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>Invisible gateway - bridge</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
>&nbsp;</TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>ALTQ - allocation by percentage</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>