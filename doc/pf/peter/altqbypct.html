<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>ALTQ - allocation by percentage</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK
REL="HOME"
TITLE="Firewalling with OpenBSD's PF packet filter
  "
HREF="index.html"><LINK
REL="UP"
TITLE="Directing traffic with ALTQ"
HREF="altqintro.html"><LINK
REL="PREVIOUS"
TITLE="Directing traffic with ALTQ"
HREF="altqintro.html"><LINK
REL="NEXT"
TITLE="ALTQ - handling unwanted traffic"
HREF="altqsmtp.html"><LINK
REL="STYLESHEET"
TYPE="text/css"
HREF="docbook.css"><meta
http-equiv="Content-Type"
content="text/html; charset=ISO-8859-1"></HEAD
><BODY
CLASS="SECTION"
BGCOLOR="#FFFFFF"
TEXT="#000000"
LINK="#0000FF"
VLINK="#840084"
ALINK="#0000FF"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="3"
ALIGN="center"
>Firewalling with OpenBSD's PF packet filter</TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="bottom"
><A
HREF="altqintro.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="80%"
ALIGN="center"
VALIGN="bottom"
>Directing traffic with ALTQ</TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="bottom"
><A
HREF="altqsmtp.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="SECTION"
><H1
CLASS="SECTION"
><A
NAME="ALTQBYPCT"
>ALTQ - allocation by percentage</A
></H1
><P
>We move on to another example, which I for all practical purposes
swiped from the Swedish site unix.se.  The queues are set up on the
external interface.  This is probably the more common approach, since
the limitations on bandwidth are usually more severe on the external
interface. In principle, however, allocating queues and running
traffic shaping can be done on any network interface.  Here, the setup
includes a cbq queue for a total bandwidth of 640KB with six sub
queues.</P
><PRE
CLASS="PROGRAMLISTING"
>altq on $ext_if cbq bandwidth 640Kb queue { def, ftp, udp, http, \
         ssh, icmp }
queue def bandwidth 18% cbq(default borrow red)
queue ftp bandwidth 10% cbq(borrow red)
queue udp bandwidth 30% cbq(borrow red)
queue http bandwidth 20% cbq(borrow red)
queue ssh bandwidth 20% cbq(borrow red) { ssh_interactive, ssh_bulk }
          queue ssh_interactive priority 7 bandwidth 20%
          queue ssh_bulk priority 0 bandwidth 80%
queue icmp bandwidth 2% cbq</PRE
><P
>We see the subqueue def with 18 percent of the bandwidth is designated 
as the default queue, that is any traffic not explicitly assigned to some 
other queue ends up here. The borrow and red keywords mean that the queue
may 'borrow' bandwidth from its parent queue, while the system attempts to 
avoid congestion by applying the RED (Random Early Detection) algorithm. 
The other queues follow more or less the same pattern, up to the
subqueue ssh, which itself has two subqueues with separate priorities.</P
><P
>In the ssh queue, again we see a variation of the ACK priority via
subqueues scheme: Bulk SSH transfers, typically SCP file transfers,
get transmitted with a ToS indicating normal delay, while interactive
SSH traffic has the low delay bit set and skips ahead of the bulk
transfers.</P
><P
>This scheme probably also helps the speed of SCP file transfers, since
the SCP ACK packets will be assigned to the higher priority subqueue.</P
><P
>Finally, the pass rules which show which traffic gets assigned to the queues,
and their criteria:</P
><PRE
CLASS="PROGRAMLISTING"
>pass log quick on $ext_if proto tcp from any to any port 22 flags S/SA \ 
    keep state queue (ssh_bulk, ssh_interactive)
pass in quick on $ext_if proto tcp from any to any port 20 flags S/SA  \
    keep state queue ftp
pass in quick on $ext_if proto tcp from any to any port 80 flags S/SA \
    keep state queue http
pass out on $ext_if proto udp all keep state queue udp
pass out on $ext_if proto icmp all keep state queue icmp</PRE
><P
>We can reasonably assume that this allocation meets the site's needs.</P
><P
>The full description can be found at the Unix.se site as <A
HREF="http://unix.se/Brandv%E4gg_med_OpenBSD"
TARGET="_top"
>http://unix.se/Brandv%E4gg_med_OpenBSD</A
></P
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="altqintro.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>Home</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="altqsmtp.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>Directing traffic with ALTQ</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="altqintro.html"
ACCESSKEY="U"
>Up</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>ALTQ - handling unwanted traffic</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>